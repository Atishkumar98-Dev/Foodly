{% extends "admin_base.html" %}
{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .orders-card { max-width: 1200px; margin: 12px auto; }
  .order-row:hover { background: #fbfdff; }
  .small-muted { color: #6c757d; font-size: .9rem; }
  .status-pill { padding: .28rem .55rem; border-radius: 999px; font-weight:600; color:#fff; font-size:.85rem; }
  .status-PENDING { background:#f59e0b; }
  .status-CONFIRMED { background:#0ea5e9; }
  .status-PREPARING { background:#7c3aed; }
  .status-DELIVERED { background:#16a34a; }
  .status-CANCELLED { background:#dc2626; }
  .nowrap { white-space: nowrap; }
</style>

<div class="orders-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Orders</h3>
      <small class="small-muted">Manage and update customer orders</small>
    </div>
    <div>
      <a href="{% url 'admin_food' %}" class="btn btn-outline-secondary btn-sm">Manage Foods</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Order ID</th>
              <th>User</th>
              <th>Food</th>
              <th class="text-center">Qty</th>
              <th class="text-end">Total</th>
              <th>Status</th>
              <th>Ordered At</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr class="order-row">
              <td>{{ forloop.counter }}</td>
              <td class="nowrap">#{{ order.id }}</td>
              <td>
                {% if order.user %}
                  {{ order.user.username }}<br>
                  <small class="text-muted">{{ order.user.email }}</small>
                {% else %}
                  Guest
                {% endif %}
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if order.food and order.food.image %}
                    <img src="{{ order.food.image.url }}" alt="{{ order.food.food_name }}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
                  {% endif %}
                  <div>
                    {% if order.food %}
                      <strong>{{ order.food.food_name }}</strong><br>
                      <small class="text-muted">{{ order.food.get_category_display }}</small>
                    {% else %}
                      <span class="text-muted">Item removed</span>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td class="text-center">{{ order.quantity }}</td>
              <td class="text-end">₹{{ order.total_price|default:"0.00" }}</td>
              <td>
                <span class="status-pill status-{{ order.status }}">
                  {{ order.get_status_display }}
                </span>
              </td>
              <td>{{ order.ordered_at|date:"d M Y, H:i" }}</td>
              <td class="text-center">
                <div class="btn-group" role="group">
                  <a href="{% url 'edit_order' order.id %}" class="btn btn-sm btn-outline-primary" title="Update status">Update</a>

                  <!-- Quick view modal trigger (client-side) -->
                  <button type="button" class="btn btn-sm btn-outline-secondary view-order-btn" data-order-id="{{ order.id }}"
                    data-order-user="{{ order.user.username|default:'Guest' }}"
                    data-order-food="{{ order.food.food_name|default:'-' }}"
                    data-order-qty="{{ order.quantity }}"
                    data-order-total="{{ order.total_price }}"
                    data-order-status="{{ order.get_status_display }}"
                    data-order-time="{{ order.ordered_at|date:'d M Y, H:i' }}"
                    data-bs-toggle="modal" data-bs-target="#orderViewModal">
                    View
                  </button>

                  <a href="{% url 'delete_order' order.id %}" class="btn btn-sm btn-outline-danger"
                     onclick="return confirm('Are you sure you want to delete order #{{ order.id }}?');">
                    Delete
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center p-4 text-muted">No orders found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Optional: pagination area (if you pass pagination) -->
    {% if is_paginated %}
    <div class="card-footer bg-white">
      <nav aria-label="Orders pagination">
        <ul class="pagination justify-content-end mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Prev</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<!-- ===== Order View Modal (client-side display) ===== -->
<div class="modal fade" id="orderViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-5">Order ID</dt><dd class="col-sm-7" id="ov-id">#</dd>
          <dt class="col-sm-5">User</dt><dd class="col-sm-7" id="ov-user"></dd>
          <dt class="col-sm-5">Food</dt><dd class="col-sm-7" id="ov-food"></dd>
          <dt class="col-sm-5">Quantity</dt><dd class="col-sm-7" id="ov-qty"></dd>
          <dt class="col-sm-5">Total</dt><dd class="col-sm-7" id="ov-total"></dd>
          <dt class="col-sm-5">Status</dt><dd class="col-sm-7" id="ov-status"></dd>
          <dt class="col-sm-5">Ordered At</dt><dd class="col-sm-7" id="ov-time"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <a id="ov-edit-link" href="#" class="btn btn-sm btn-primary">Edit Status</a>
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (assume included globally; include here if not) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Populate order modal from data attributes on the clicked "View" button
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.view-order-btn');
    if (!btn) return;
    const id = btn.dataset.orderId || '';
    document.getElementById('ov-id').textContent = '#' + id;
    document.getElementById('ov-user').textContent = btn.dataset.orderUser || 'Guest';
    document.getElementById('ov-food').textContent = btn.dataset.orderFood || '-';
    document.getElementById('ov-qty').textContent = btn.dataset.orderQty || '-';
    document.getElementById('ov-total').textContent = '₹' + (btn.dataset.orderTotal || '0.00');
    document.getElementById('ov-status').textContent = btn.dataset.orderStatus || '-';
    document.getElementById('ov-time').textContent = btn.dataset.orderTime || '-';
    document.getElementById('ov-edit-link').href = "{% url 'edit_order' 0 %}".replace('/0/', '/' + id + '/');
  });
</script>
{% endblock %}
