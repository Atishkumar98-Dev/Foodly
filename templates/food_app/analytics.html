{% extends "admin_base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid my-4">

  <!-- Dashboard Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Analytics Dashboard</h2>
    <p class="text-muted">Overview of Orders, Foods, Revenue & Stock</p>
  </div>

  <!-- Top Metrics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 p-3 text-center">
        <h5>Total Orders</h5>
        <p class="display-6 fw-bold text-primary">{{ total_orders }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 p-3 text-center">
        <h5>Total Revenue</h5>
        <p class="display-6 fw-bold text-success">₹{{ total_revenue }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 p-3 text-center">
        <h5>Total Foods</h5>
        <p class="display-6 fw-bold text-warning">{{ total_foods }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 p-3 text-center">
        <h5>Pending Orders</h5>
        <p class="display-6 fw-bold text-danger">{{ pending_orders }}</p>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4 mb-4">
    <!-- Orders per Day -->
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Orders Per Day</h5>
        <canvas id="ordersChart" height="200"></canvas>
      </div>
    </div>
    <!-- Revenue per Day -->
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Revenue Per Day</h5>
        <canvas id="revenueChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Popular Foods Table -->
  <div class="row g-4">
    <div class="col-md-12">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Top Selling Foods</h5>
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Food</th>
              <th>Category</th>
              <th>Orders</th>
              <th>Total Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% for food in popular_foods %}
            <tr>
              <td>{{ food.food_name }}</td>
              <td>{{ food.get_category_display }}</td>
              <td>{{ food.order_count }}</td>
              <td>₹{{ food.revenue }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No data available</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Stock Levels Table -->
  <div class="row g-4 mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Stock Levels</h5>
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Food</th>
              <th>Category</th>
              <th>Stock Quantity</th>
            </tr>
          </thead>
          <tbody>
            {% for stock in stocks %}
            <tr>
              <td>{{ stock.food.food_name }}</td>
              <td>{{ stock.food.get_category_display }}</td>
              <td>
                <span class="{% if stock.quantity <= 5 %}text-danger{% else %}text-success{% endif %} fw-bold">
                  {{ stock.quantity }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center">No stock data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Orders per Day Chart
  const ordersCtx = document.getElementById('ordersChart').getContext('2d');
  new Chart(ordersCtx, {
      type: 'line',
      data: {
          labels: {{ orders_dates|safe }},
          datasets: [{
              label: 'Orders',
              data: {{ orders_count|safe }},
              backgroundColor: 'rgba(78, 115, 223, 0.2)',
              borderColor: 'rgba(78, 115, 223, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { display: false }
          },
          scales: {
              y: { beginAtZero: true }
          }
      }
  });

  // Revenue per Day Chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  new Chart(revenueCtx, {
      type: 'bar',
      data: {
          labels: {{ revenue_dates|safe }},
          datasets: [{
              label: 'Revenue',
              data: {{ revenue_amounts|safe }},
              backgroundColor: 'rgba(28, 200, 138, 0.7)',
              borderColor: 'rgba(28, 200, 138, 1)',
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
      }
  });
</script>
{% endblock %}
